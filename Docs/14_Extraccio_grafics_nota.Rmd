---
title: "Gràfics Presentació"
date: "14/07/21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(knitr)
library(kableExtra)
```

#

```{r}
# dades simulacions
anyo <- "2020"
tt   <- NA
terr <- "AMB"

U3   <- readRDS(here::here("Outputs/210420_AMB_U3_100000_TRUE/_targets/objects/F4_dd_dashb"))
U5   <- readRDS(here::here("Outputs/210621_U5-AMB___100000_TRUE/_targets/objects/F4_dd_dashb"))
U6   <- readRDS(here::here("Outputs/210621_U5-AMB___100000_TRUE/_targets/objects/F5_contrafactic"))

```

```{r}
# dades EMCV

ruta2 <- "~/Dropbox/2. Laboral/IERMB/0_Dades/EMCV/bases/201211_EMCV_1819.RDS"

dd <- readRDS(ruta2) %>% 
   filter(CAMB %in% c("Barcelona", "Resta AMB"))

```


```{r}

theme_set(theme_light(base_size = 12, 
           base_family = 'Arial') +
  theme(
     panel.grid.major = element_line(colour = "gray90", 
                                     linetype = "dashed", 
                                     size = 0.35), 
     panel.grid.minor = element_blank(), 
     panel.border = element_rect(colour = "gray85", 
                                     size = .8),
     legend.position = "bottom", 
     legend.title = element_text(face = "bold"), 
     strip.background = element_rect(colour = "white",
                                     fill = "white"),
     strip.text = element_text(color = "gray20")
  ))

my_pal <- RColorBrewer::brewer.pal(n = 11, "RdGy")[c(2, 9, 4, 11)] 


```

```{r}
mykable <- function(tab){
   tab %>% 
      knitr::kable(., digits = 1, "html") %>% 
      kable_styling(bootstrap_options =
                       c("striped", 
                         "hover", 
                         "condensed", 
                         "responsive"), 
                    full_width = F, 
                    position = "left")
      
}
```


# Gràfic cascada

**NOTA: el càlcul d'aquests gràfics ha canviat. cal verificar que aquesta versió segueixi el mateix procediment que el document 11 d'explotació de resultats.** (14/07/21 -  la lara no ho necessita avui i per això no ho revisaré ara, però en el futur podria ser necessari)

gràfic diferències entre decils per escenaris U3 i U5: modificar eix X per a que apareguin nombres dels decils, desar còpia amb màxima resolució i escalable


```{r}

source("~/Dropbox/R/01_Repo_codi_propi/2. Analitza dades/Calcula_quantils_igual_SPSS.R")

U3$COV_deciles_IMV <- fes_WQnt(ie  = U3$COV_IE_IMV, 
                               pes = U3$RB050, 
                               ps  = seq(0,1, .1))

U5$COV_deciles_IMV <- fes_WQnt(ie  = U5$COV_IE_IMV, 
                               pes = U5$RB050, 
                               ps  = seq(0,1, .1))


r3 <- U3 %>% 
   group_by(COV_deciles_IMV) %>% 
   summarise(avg = Hmisc::wtd.mean(COV_IE_IMV, 
                                   weights = RB050, 
                                   na.rm = T))
r5 <- U5 %>% 
   group_by(COV_deciles_IMV) %>% 
   summarise(avg = Hmisc::wtd.mean(COV_IE_IMV, 
                                   weights = RB050, 
                                   na.rm = T))

T2 <- 
tibble::tribble(
   ~Decil,  ~`2018-2019`,    ~`simU3`,   ~`simU5`,     
       1,        4862.91,  r3[[1, 2]], r5[[1, 2]],  
       2,        9498.84,  r3[[2, 2]], r5[[2, 2]],  
       3,       12388.87,  r3[[3, 2]], r5[[3, 2]],  
       4,       14971.61,  r3[[4, 2]], r5[[4, 2]],  
       5,       17184.30,  r3[[5, 2]], r5[[5, 2]],  
       6,       19839.57,  r3[[6, 2]], r5[[6, 2]],  
       7,       22735.75,  r3[[7, 2]], r5[[7, 2]],  
       8,       26820.84,  r3[[8, 2]], r5[[8, 2]],  
       9,       32956.16,  r3[[9, 2]], r5[[9, 2]],  
      10,       51211.20,  r3[[10, 2]],r5[[10, 2]] 
   ) 

oldnm <- (names(T2))

names(T2) <- LETTERS[1:(ncol(T2))]

T2 <- 
T2 %>% 
mutate(VariacioU3 = round((C - B)/B * 100,1),
       VariacioU5 = round((D - B)/B * 100,1))

names(T2) <- c(oldnm, "Escenari I", "Escenari II")

T2 %>% 
   select(Decil, 
          contains("Escenari")) %>% 
   gather("Var", "Val", - Decil) %>% 
   ggplot(., 
          aes(x = Decil, 
              y = Val, 
              fill = Val, 
              label = Val)) +
   geom_bar(stat = "identity") + 
   geom_text( 
      # aes(x = Decil, 
      #             y = 0),
      size = 2.3, 
      position = position_dodge(width = 1),
      vjust = -0.5) +
   scale_fill_distiller(palette = "Reds") + 
   scale_x_continuous(breaks = seq(1,10,1), 
                    labels = seq(1,10,1)) +
   facet_wrap(.~Var) +
   labs(
      y = "Variació %", 
      fill = NULL
   )
   

```

```{r eval=FALSE, include=FALSE}
  ggsave("cascada.svg", 
       dpi    = 320, 
       dev    = 'svg', # "pdf", "svg"
       # height = 4.5, 
       # width  = 6.5, 
       units  = "cm")

```

```{r}
mykable(T2)
```

**Gràfic 1.1. Variació percentual de la mitjana d’ingressos equivalents segons decils de renda (3 grups) del 2020 respecte 2018-2019 (%). Total població. Barcelona, 2020**

```{r}

U3$gdec <- factor(
   U3$COV_deciles_IMV, 
   levels = levels(U3$COV_deciles_IMV), 
      labels = c(
         rep("baixa", 3), 
         rep("mitjana", 4), 
         rep("alta", 3))
)

U5$gdec <- factor(
   U5$COV_deciles_IMV, 
   levels = levels(U5$COV_deciles_IMV), 
      labels = c(
         rep("baixa", 3), 
         rep("mitjana", 4), 
         rep("alta", 3))
)

dd$gdec <- factor(
   dd$Decils_TAMB, 
   levels = levels(dd$Decils_TAMB), 
      labels = c(
         rep("baixa", 3), 
         rep("mitjana", 4), 
         rep("alta", 3))
)


r3 <- U3 %>% 
   group_by(gdec) %>% 
   summarise(avg = Hmisc::wtd.mean(COV_IE_IMV, 
                                   weights = RB050, 
                                   na.rm = T))
r5 <- U5 %>% 
   group_by(gdec) %>% 
   summarise(avg = Hmisc::wtd.mean(COV_IE_IMV, 
                                   weights = RB050, 
                                   na.rm = T))
ro <- dd %>% 
   group_by(gdec) %>% 
   summarise(avg = Hmisc::wtd.mean(IE, 
                                   weights = RB050, 
                                   na.rm = T))

T2 <- 
tibble::tribble(
   ~Grup,  ~`2018-2019`,    ~`simU3`,   ~`simU5`,     
  "Baixa",    ro[[1,2]],   r3[[1,2]],  r5[[1,2]],
  "Mitjana",  ro[[2,2]],   r3[[2,2]],  r5[[2,2]],
  "Alta",     ro[[3,2]],   r3[[3,2]],  r5[[3,2]]
   ) 

oldnm <- (names(T2))

names(T2) <- LETTERS[1:(ncol(T2))]

T2 <- 
T2 %>% 
mutate(VariacioU3 = round((C - B)/B * 100,1),
       VariacioU5 = round((D - B)/B * 100,1))

names(T2) <- c(oldnm, "Escenari I", "Escenari II")
```

```{r dpi= 300}
T2 %>% 
   mutate(Grup = forcats::fct_inorder(Grup)) %>% 
   select(Grup, 
          contains("Escenari")) %>% 
   gather("Var", "Val", - Grup) %>% 
   ggplot(., 
          aes(x = Grup, 
              y = Val, 
              fill = Val, 
              label = Val)) +
   geom_bar(stat = "identity") + 
   geom_text(
      size = 2.3, 
      position = position_dodge(width = 1), 
      vjust = -.5
   ) +
   scale_fill_distiller(palette = "Reds") + 
   facet_wrap(.~Var) +
   labs(
      y = "Variació %", 
      fill = NULL
   )

```

```{r eval=FALSE, include=FALSE}
  ggsave("cascada.svg", 
       dpi    = 320, 
       dev    = 'svg', # "pdf", "svg"
       # height = 4.5, 
       # width  = 6.5, 
       units  = "cm")

```

```{r eval=FALSE, include=FALSE}
mykable(T2)
```

# Gràfic perfils demogràfics

gràfic perfils: canviant observat vs. estimats per observats, U3 i U5

també gràfic perfils: invertir ordre labels en variables ordinals, i nom etiquetes i variables: fer descripció més clara. Totes les referències a TRP fent servir ancorada

```{r}
mvars <- c("RB090", "RB080_R8", "PB210_R1", 
           "HX060_R1", "ESEC6")
mpes <- c("RB050", "RB050", "PB040",
          "RB050", "PB040")

```

```{r}
g51U3 <- 
purrr::map2(mvars, mpes, function(x, pes){
   X <- sym(x)
   ps <- sym(pes)
 
   U3 %>%
    select(COV_TRP_ANC_IMV60, all_of(x), pes) %>% 
    filter(complete.cases(.)) %>% 
      group_by({{X}}) %>%
      count(COV_TRP_ANC_IMV60, wt = {{ps}}) %>%
      mutate(tt = sum(n),
             pp = n/tt*100) %>%
      filter(COV_TRP_ANC_IMV60 == "Pobre") %>%
      pull(pp)
})


g51U5 <- 
purrr::map2(mvars, mpes, function(x, pes){
   # stop()
   X <- sym(x)
   ps <- sym(pes)
 
   U5 %>%
    select(COV_TRP_ANC_IMV60, all_of(x), pes) %>% 
    filter(complete.cases(.)) %>% 
      group_by({{X}}) %>%
      count(COV_TRP_ANC_IMV60, wt = {{ps}}) %>%
      mutate(pp = n/sum(n)*100) %>%
      filter(COV_TRP_ANC_IMV60 == "Pobre") %>%
      pull(pp)
})


```

```{r}
T5 <- 
tibble::tribble(
          ~var,                   ~categories,  ~`2018-2019`,    ~`Escenari I`,   ~`Escenari II`,
        "Sexe",                       "Homes",    19.9,    g51U3[[1]][2],  g51U5[[1]][2],
        "Sexe",                       "Dones",    20.1,    g51U3[[1]][1],  g51U5[[1]][1],
        "Edat",                   "0-17 anys",    27.0,    g51U3[[2]][1],  g51U5[[2]][1],
        "Edat",                  "18-34 anys",    21.5,    g51U3[[2]][2],  g51U5[[2]][2],
        "Edat",                  "35-64 anys",    18.2,    g51U3[[2]][3],  g51U5[[2]][3],
        "Edat",                    "65+ anys",    16.7,    g51U3[[2]][4],  g51U5[[2]][4],
        "Naix.",                     "Espanya",    12.7,    g51U3[[3]][1],  g51U5[[3]][1],
        "Naix.",               "Resta del món",    39.6,    g51U3[[3]][2],  g51U5[[3]][2],
       "Llars",       "Unipersonal < 65 anys",    26.8,    g51U3[[4]][4],  g51U5[[4]][4],
       "Llars",       "Unipersonal > 65 anys",    33.1,    g51U3[[4]][3],  g51U5[[4]][3],
       "Llars",               "sense infants",    13.1,    g51U3[[4]][2],  g51U5[[4]][2],
       "Llars",                 "amb infants",    24.6,    g51U3[[4]][1],  g51U5[[4]][1],
        "ESeC",   "Directius i professionals",     9.2,    g51U3[[5]][1],  g51U5[[5]][1],
        "ESeC",      "Ocupacions intermèdies",    10.3,    g51U3[[5]][2],  g51U5[[5]][2],
        "ESeC","Petits empresaris i autònoms",    27.8,    g51U3[[5]][3],  g51U5[[5]][3],
        "ESeC",  "Semiqualificats de serveis",    21.9,    g51U3[[5]][4],  g51U5[[5]][4],
        "ESeC", "Semiqualificats o de rutina",    24.8,    g51U3[[5]][5],  g51U5[[5]][5],
        "ESeC",                    "ALLD/NTM",    30.1,    g51U3[[5]][6],  g51U5[[5]][6] 
   ) %>% 
   mutate(
      categories = forcats::fct_inorder(categories), 
      var = forcats::fct_inorder(var), 
      categories = forcats::fct_rev(categories))
```

```{r, fig.asp = 0.8}
T5 %>% 
   gather("Any", "Val", -c(var, categories)) %>% 
   ggplot(., 
          aes(y = categories, 
              x = Val, 
              color = Any, 
              group = categories)) +
   geom_line(color = "gray", 
                 linetype = "longdash", 
                 size = .3) + 
   geom_point(size = 2) +
   scale_colour_manual(values = c("#878787", 
                                  "#D6604D",
                                  "#67001F" 
                                  )) +
   facet_grid(var~., 
              drop = T, 
              scales = "free", 
              space = "free") + 
   labs(
      x = "%", 
      y = NULL, 
      color = NULL
   )

```

```{r}
  ggsave("perfils.svg", 
       dpi    = 320, 
       dev    = 'svg', # "pdf", "svg"
       height = 15, 
       width  = 19, 
       units  = "cm")

```

```{r}
mykable(T5)
```


# Escut social

gràfic amb comparació situacions escut social: bretxa protecció, element gràfic per visualitzar diferència en protecció TRP

I després en el la seqüència de l’escut social crec que falta encara ERTO sense IMV amb la TRP ancorada; A la seqüència inclourem també la intensitat de pobresa

Incloure el Gini

```{r}
# Gini
Gu5 <- U5 %>% 
   summarise(laeken::gini(inc = COV_IE_Gini_IMV, 
                          weights = RB050)$value) %>% 
   .[[1,1]]
Gu52 <- U5 %>% 
   summarise(laeken::gini(inc = COV_IE_Gini, 
                          weights = RB050)$value) %>% 
   .[[1,1]]
Gu6 <- U6 %>% 
   summarise(laeken::gini(inc = COV_IE_Gini_IMV, 
                          weights = RB050)$value) %>% 
   .[[1,1]]

# Intensitat

fes_IRP <- function(dades){
   
llindarU5 <- (Hmisc::wtd.quantile(x    = dades$COV_IE_IMV, 
                               weights = dades$RB050, 
                               probs   = c(.5)) * .6) %>% 
   unname(.)

mediana_pU5 <- dades %>% 
   filter(COV_TRP_IMV60 == "Pobre") %>% 
   summarise(med_p = Hmisc::wtd.quantile(x       = COV_IE_IMV, 
                                         weights = RB050, 
                                         probs   = c(.5))) %>% 
   pull(med_p) %>% unname(.)

   round((llindarU5 - mediana_pU5) / llindarU5, 3)

}

irpU5 <- fes_IRP(U5)
irpU6 <- fes_IRP(U6)

llindarU52 <- (Hmisc::wtd.quantile(x   = U5$COV_IE, 
                               weights = U5$RB050, 
                               probs   = c(.5)) * .6) %>% 
   unname(.)

mediana_pU52 <- U5 %>% 
   filter(COV_TRP60 == "Pobre") %>% 
   summarise(med_p = Hmisc::wtd.quantile(x       = COV_IE, 
                                         weights = RB050, 
                                         probs   = c(.5))) %>% 
   pull(med_p) %>% unname(.)

irpU52 <- round((llindarU52 - mediana_pU52) / llindarU52, 3)

# TRP  ancorada

fes_TRP <- function(dades, trp){
   trp <- sym(trp)
   
   dades %>% 
   count({{trp}}, wt = RB050) %>% 
   mutate(pp = n/sum(n) * 100) %>% 
   filter({{trp}} == "Pobre") %>% 
   pull(pp)
}

trp60U5 <- fes_TRP(U5, "COV_TRP_ANC_IMV60")
trp60U52 <- fes_TRP(U5, "COV_TRP_ANC60")
trp60U6 <- fes_TRP(U6, "COV_TRP_ANC_IMV60")

trp30U5 <- fes_TRP(U5, "COV_TRP_ANC_IMV30")
trp30U52 <- fes_TRP(U5, "COV_TRP_ANC30")
trp30U6 <- fes_TRP(U6, "COV_TRP_ANC_IMV30")


T6 <- 
tibble::tribble(
   ~Indicador,  ~`Escenari II`,  ~`Escenari IIB`,    ~`Escenari III`,     
     "Gini",         Gu5,                   Gu52,                Gu6,  
     "IRP",        irpU5,                 irpU52,              irpU6,  
     "TRP60",    trp60U5,               trp60U52,            trp60U6,  
     "TRP30",    trp30U5,               trp30U52,            trp30U6  
   ) %>% 
   mutate(Indicador = forcats::fct_rev(Indicador))


```

```{r , fig.asp = 0.5}
T6 %>% 
   gather("Var", "Val", -Indicador) %>% 
   ggplot(., 
          aes(y = Val, 
              x = Indicador, 
              color = Var)) + 
   coord_flip() +
      geom_line(color = "gray", 
                 linetype = "longdash", 
                 size = .3) + 
   geom_point(size = 3) +
   scale_colour_manual(values = c("#D6604D",
                                  "#B2182B" ,
                                  "#67001F"  
                                  )) +
   facet_wrap(Indicador~., 
              drop = T, 
              scales = "free") + 
   theme(strip.text = element_text(color = "white")) +
   ylim(0, NA) +
   labs(
      x = NULL, 
      y = NULL, 
      color = NULL
   )

   


```


```{r}
  ggsave("escut.svg", 
       dpi    = 320, 
       dev    = 'svg', # "pdf", "svg"
       height = 10,
       width  = 19,
       units  = "cm")

```

```{r}
T6 %>% 
      knitr::kable(., digits = 3, "html") %>% 
      kable_styling(bootstrap_options =
                       c("striped", 
                         "hover", 
                         "condensed", 
                         "responsive"), 
                    full_width = F, 
                    position = "left")
```



# HCB

```{r}

# fes_hcb <- function(dades){
#    
#    dades$COV_HCB <- (((dades$HH070 * 12) - dades$HY070N)/(dades$COV_hy020_IMV - dades$HY070N)) * 100
# 
#    # Correccions necessàries
#    dades$COV_HCB[((dades$HH070 * 12) - dades$HY070N) < 0] <- 0 # Si les despeses llar menys les    transferències és menor a 0 (les transferències cobreixen més que les despeses), la sobrecàrrega    és 0
#    dades$COV_HCB[(dades$COV_hy020_IMV - dades$HY070N) <= 0] <- 100 #Si els ingressos menys les    transferències és menor que 0 (tots els ingressos són les transferències per llar), la    sobrecàrrega és 100
#    dades$COV_HCB[(dades$COV_hy020_IMV - dades$HY070N) < ((dades$HH070*12) - dades$HY070N)] <- 100 #si ingressos    menys transferències és menor a despeses menys transferències, la sobrecàrrega és 100
# 
#    dades$COV_Taxa_HCB <- as.factor(
#    cut(dades$COV_HCB, 
#    breaks = c(0, 40, 100), 
#    include.lowest = T, 
#    right = T, 
#    labels = c("Sense sobrecàrrega", 
#               "Amb sobrecàrrega")))
#    
#    dades$COV_Taxa_HCB60 <- as.factor(
#    cut(dades$COV_HCB, 
#    breaks = c(0, 60, 100), 
#    include.lowest = T, 
#    right = T, 
#    labels = c("Sense sobrecàrrega", 
#               "Amb sobrecàrrega")))
#    return(dades)
# }
# 
# U3 <- fes_hcb(U3)
# U5 <- fes_hcb(U5)
# 
# U3[,"RTL3"] <- dd$RTL3[match(U3$ID, dd$ID)]
# U5[,"RTL3"] <- dd$RTL3[match(U5$ID, dd$ID)]

levels(U3$COV_Taxa_HCB) <- c("Sense sobrecàrrega", "Amb sobrecàrrega")
levels(U5$COV_Taxa_HCB) <- c("Sense sobrecàrrega", "Amb sobrecàrrega")
levels(U3$COV_Taxa_HCB60) <- c("Sense sobrecàrrega", "Amb sobrecàrrega")
levels(U5$COV_Taxa_HCB60) <- c("Sense sobrecàrrega", "Amb sobrecàrrega")

extreu_hcb <- function(dades, mv = "mv"){
   mv <- sym(mv)
   
   p1 <- 
   dades %>% 
   count({{mv}}, wt = RB050) %>% 
   mutate(tt = sum(n), 
          pp = n/tt * 100) %>% 
   filter({{mv}} == "Amb sobrecàrrega") %>% 
   select(pp) %>% 
   mutate(RTL3 = "total")
   
   p2 <- dades%>% 
   group_by(RTL3) %>% 
   count({{mv}}, wt = RB050) %>% 
   mutate(tt = sum(n), 
          pp = n/tt * 100) %>% 
   filter({{mv}} == "Amb sobrecàrrega") %>% 
   filter(RTL3 %in% c("En propietat amb hipoteca", 
                      "En lloguer")) %>% 
   select(RTL3, pp) %>% 
   mutate(RTL3 = factor(RTL3, 
                        levels = c("En propietat amb hipoteca", 
                                   "En lloguer"), 
                        labels = c("hipoteca", 
                                   "lloguer")))
   
   bind_rows(p2, p1)
      
}

hcbu3_40 <- extreu_hcb(U3, "COV_Taxa_HCB") %>% 
   mutate(escenari = "Escenari I", 
          `sobrecàrrega` = ">40%")
hcbu5_40 <- extreu_hcb(U5, "COV_Taxa_HCB") %>% 
   mutate(escenari = "Escenari II", 
          `sobrecàrrega` = ">40%")
hcbu3_60 <- extreu_hcb(U3, "COV_Taxa_HCB60") %>% 
   mutate(escenari = "Escenari I", 
          `sobrecàrrega` = ">60%")
hcbu5_60 <- extreu_hcb(U5, "COV_Taxa_HCB60") %>% 
   mutate(escenari = "Escenari II" , 
          `sobrecàrrega` = ">60%")

dhcb <- bind_rows(
   hcbu3_40, 
   hcbu5_40, 
   hcbu3_60, 
   hcbu5_60 
                  ) %>% 
   mutate(escenari = forcats::fct_relevel(escenari, "Escenari II", after = 0L))


ttemp <- 
tibble::tribble(
      ~RTL3,     ~`sobrecàrrega`,   ~`escenari`,     ~pp,
    "hipoteca",     ">40%",         "2016-2017",     3.6,
     "lloguer",     ">40%",         "2016-2017",    37.3,
    "hipoteca",     ">40%",         "2017-2018",     3.6,
     "lloguer",     ">40%",         "2017-2018",    35.8,
    "hipoteca",     ">40%",         "2018-2019",     3.3,
     "lloguer",     ">40%",         "2018-2019",    34.9,
    "hipoteca",     ">60%",         "2016-2017",      1.5,
     "lloguer",     ">60%",         "2016-2017",      16.7,
    "hipoteca",     ">60%",         "2017-2018",      1.4,
     "lloguer",     ">60%",         "2017-2018",      18.4,
    "hipoteca",     ">60%",         "2018-2019",      1.1,
     "lloguer",     ">60%",         "2018-2019",      18.1,
       "total",     ">40%",         "2016-2017",      12.5, 
       "total",     ">40%",         "2017-2018",      12.9, 
       "total",     ">40%",         "2018-2019",      13.0, 
       "total",     ">60%",         "2016-2017",       5.9, 
       "total",     ">60%",         "2017-2018",       6.7, 
       "total",     ">60%",         "2018-2019",       6.7
   ) 


dhc <- bind_rows(
   dhcb, 
   ttemp
)


```

```{r eval=FALSE, include=FALSE}
dhcb %>% 
   ggplot(., 
          aes(
             x = escenari, 
             y = pp, 
             color = RTL3
          )) + 
   geom_point(size = 3) +
   coord_flip() +
   facet_grid(.~`sobrecàrrega`) +
      scale_colour_manual(values = c( 
                                  "#67001F",
                                  "#D6604D",
                                  "#878787"
                                  )) +
   labs(
      x = NULL, 
      y = "%", 
      color = NULL
   )

```

```{r}

dhp <- dhc %>% 
   mutate(anyo = ifelse(grepl(pattern ="Escenari",
                              x = escenari), 
                        2020, 
                        escenari), 
          escenari = ifelse(grepl(pattern ="Escenari",
                              x = escenari), 
                        escenari, 
                        "observat"), 
          escenari = factor(escenari, 
                            levels = c("observat", 
                                       "Escenari I", 
                                       "Escenari II" 
                                       ))
          )

obs <- dhp %>% 
   filter(escenari == "observat")
est <- dhp %>% 
   filter(anyo %in% c(2020, "2018-2019")) %>% 
   bind_rows(., .[13:18,]) %>% 
   arrange(anyo, `sobrecàrrega`, RTL3)
est$id <- rep(seq(1,12,1),2)

labs <- dhp %>% 
   filter(anyo == "2016-2017")

ggplot() +
   geom_line(data = obs,
             aes(
                x = anyo,
                y = pp,
                group = RTL3
             ),
             color = "gray80",
             size = 1) +
   geom_line(data = est, 
             aes(
                x = anyo, 
                y = pp, 
                group = id
             ), 
             color = "gray80",
             linetype = "dashed") +
   geom_point(data = dhp,
              aes(
                 x = anyo,
                 y = pp,
                 group = RTL3,
                 color = escenari
              ),
              size = 3) +
   geom_text(data = labs, 
             aes(
                x = anyo, 
                y = (pp - 2), 
                label = RTL3
             ), 
             color = "gray20", 
             size = 3.5) +
   facet_grid(. ~ `sobrecàrrega`) +
   scale_colour_manual(values = c("#878787", 
                                  "#D6604D",
                                  "#67001F"
                                  )) +
   labs(x = NULL,
        y = "%",
        color = NULL)

   
   
```


```{r}
  ggsave("hcb.svg", 
       dpi    = 320, 
       dev    = 'svg', # "pdf", "svg"
       height = 9,
       width  = 19,
       units  = "cm")

```

```{r}
mykable(dhc)
```


gràfic sobrecàrrega: gràfic en facets amb RTL lloguer i pagaments pendents, comparant 60i 40%, facetes amb escenaris U3 i U5; Als gràfics de sobrecàrrega estaria bé afegir també el total

# Save


```{r eval=FALSE, include=FALSE}
# In order to save the figure we will use ggsave. (Note the size increase of Figure 2b is due to presenting this on the web at 300 dpi - the ggsave function shown below will save a figure in a specified format at a chosen resolution and size).

ggsave("figure2b.png", 
       dpi    = 320, 
       dev    = 'png', # "pdf", "svg"
       height = 4.5, 
       width  = 6.5, 
       units  = "cm")

```





