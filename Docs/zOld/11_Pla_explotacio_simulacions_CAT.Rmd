---
title: "Explotació resultats simulació - CAT"
date: "`r format(Sys.time(), '%d %B, %Y - %H:%M')`"
author: "IERMB"
output: 
 prettydoc::html_pretty:
  theme: architect
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      dpi = 300
                      )
```

```{r library, message=FALSE, warning=F, include=F}
library(tidyverse, warn.conflicts = F, quietly = T)
library(knitr, warn.conflicts = F, quietly = T)
library(rlang, warn.conflicts = F, quietly = T)
library(scales, warn.conflicts = F, quietly = T)
library(kableExtra, warn.conflicts = F, quietly = T)
```

```{r dades}

df <- readRDS(here::here("_targets",
                         "objects",
                         "F4_dd_dashb"))

ruta <- here::here("Docs", "11_taules_pla_explt_CAT.xlsx")
fulls <- openxlsx::getSheetNames(ruta)
taules <- lapply(fulls, function(x){
   openxlsx::read.xlsx(xlsxFile = ruta, sheet = x)  
}) %>% 
   purrr::set_names(fulls)

rm("ruta", "fulls")

param <- readRDS(here::here("_targets", "objects", "parametres"))

```

```{r}
df$PIL <- ifelse(df$ID %in% (df$RB010 * 10^8 + df$HB080), T, F) 

mediana <- Hmisc::wtd.quantile(df$COV_IE_IMV, df$RB050, c(.5))
df$estrats <- factor(dplyr::case_when(
   df$COV_IE_IMV <= mediana *  .3  ~ "Pobresa extrema (<30% mediana)", 
   df$COV_IE_IMV <= mediana *  .6  ~ "Pobresa (>30% <60% mediana)", 
   df$COV_IE_IMV <= mediana *  .75 ~ "Precaris (>60% <75% mediana)", 
   df$COV_IE_IMV <= mediana * 1.25 ~ "CM baixa (>75% <125% mediana)", 
   df$COV_IE_IMV <= mediana * 1.66 ~ "CM alta (>125% <166% mediana)", 
   df$COV_IE_IMV >  mediana * 1.66 ~ "Classe alta (>166% mediana)" 
 ), 
levels = c(
  "Pobresa extrema (<30% mediana)", 
  "Pobresa (>30% <60% mediana)", 
  "Precaris (>60% <75% mediana)", 
  "CM baixa (>75% <125% mediana)", 
  "CM alta (>125% <166% mediana)", 
  "Classe alta (>166% mediana)" 
))

```

```{r}
edicions1 <- c("1985", "1990", "1995","2000", 
               "2006", "2011", "16-17", 
              "17-18", "18-19", "sim2020")
edicions2 <- c("2006", "2011", "16-17", 
              "17-18", "18-19", "sim2020")
```

```{r}
fes_pp <- function(x, tt){
   # stop()
   round((x/tt * 100), 2)
}
```

```{r mykable}
mykable <- function(tab){
   tab %>% 
      knitr::kable(., digits = 1, "html") %>% 
      kable_styling(bootstrap_options =
                       c("striped", 
                         "hover", 
                         "condensed", 
                         "responsive"), 
                    full_width = F, 
                    position = "left")
      
}
```

```{r theme}
old <- theme_set(theme_minimal())

my_pal <- RColorBrewer::brewer.pal(n = 11, "RdGy")[c(2, 9, 4, 11)] 

```

```{r peces_taula_ID}
# defineix les peces clau per la taula amb identificadors simulació
esc    <- param$val[param$param == "UN"]
iter   <- param$val[param$param == "iteracions"] %>% as.double(.)
atur   <- readRDS(here::here("_targets", "objects", "F1_TGatur")) %>% 
   round(., 3) %>%  as.double(.) * 100
erto   <- (as.double(param$val[param$param == "Taxa_erto_proj"]) * 100) %>% round(.,1)
prop   <- readRDS(here::here("_targets", "objects", "F1_TGcob"))  %>% 
   round(.,3) %>% as.double(.) * 100
epa    <- param$val[param$param == "epa"]
infERT <- param$val[param$param == "erto"]
ambit <- unique(df$ambit_simulacio)
bsl_dt <- ifelse(ambit %in% c("BCN", "AMB", "ATM"), "EMCV", "ECV")
titol  <- paste0(ambit, " - ", epa)

```

```{r taula_ID}

tibble::tribble(
  ~Variable,                       ~Valor, 
  "Territori",                      ambit, 
  "Escenari",                       esc,
  "n",                              as.character(nrow(df)),
  "Iteracions",                     as.character(iter),
  "Data simulació",                 format(Sys.time(), '%d/%m/%y'),
  "Font dades atur",                paste0("EPA ", epa), 
  "Referència temp. ERTOS",         infERT,
  "Taxa d'atur projectada",         as.character(atur), 
  "Proporció atur amb prestació",   as.character(prop), 
  "Població afectada per ERTO",     as.character(erto), 
  "Assignació mesos a l'atur",      "probabilística", 
  "Base dades renda",               bsl_dt
) %>%
  kable(., caption = "Referències simulació", digits = 1) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F)

```


### Taula 1. 

Renda anual neta mitjana per llar, persona i unitat de consum (euros). AMB, 2016-2017, 2017-2018, 2018-2019 i estimacions 2020. 


```{r}
p111 <- df %>% 
   filter(PIL) %>% 
   summarise(RANMllar = Hmisc::wtd.mean(x = COV_hy020_IMV, 
                                        weights = RB050,
                                        na.rm = T)) %>% 
   pull(RANMllar)

p112 <- df %>% 
   mutate(rper = COV_hy020_IMV/HX040) %>% 
   summarise(RANMper = Hmisc::wtd.mean(x = rper, 
                                       weights = RB050, 
                                       na.rm = T))%>% 
   pull(RANMper)

p113 <- df %>% 
   summarise(RANMuc = Hmisc::wtd.mean(x = COV_IE_IMV, 
                                      weights = RB050, 
                                      na.rm = T)) %>% 
   pull(RANMuc)

```

```{r}
T1 <- taules$Taula1
T1$sim2020 <- c(p111, p112, p113)
T1 %>% 
   mykable(.)

```


### Taula 2. 

Variació relativa en la mitjana dels ingressos equivalents de la població  segons decils de renda

```{r}

source(here::here("R", "Calcula_quantils_igual_SPSS.R"))
# source("~/Dropbox/R/01_Repo_codi_propi/2. Analitza dades/Calcula_quantils_igual_SPSS.R")

df$COV_deciles_IMV <- fes_WQnt(ie  = df$COV_IE_IMV, 
                               pes = df$RB050, 
                               ps  = seq(0,1, .1))

df$deciles_orig <- fes_WQnt(ie  = df$INGRESSOS_EQUIV, 
                               pes = df$RB050, 
                               ps  = seq(0,1, .1))

r2 <- df %>% 
   group_by(COV_deciles_IMV) %>% 
   summarise(avg = Hmisc::wtd.mean(.data$COV_IE_IMV, 
                                   weights = .data$RB050, 
                                   na.rm = T))

r3 <- df %>% 
   group_by(deciles_orig) %>% 
   summarise(avg = Hmisc::wtd.mean(.data$COV_IE_IMV, 
                                   weights = .data$RB050, 
                                   na.rm = T))

```

```{r eval=FALSE, include=FALSE}
do %>% 
   group_by(Decils_BCN) %>% 
   summarise(avg = mean(IE, na.rm = T)) %>% pull(avg)
```

```{r}
T2 <- taules$Taula2
T2$quartils_sim <- c(
   r2[[1, 2]], 
   r2[[2, 2]], 
   r2[[3, 2]], 
   r2[[4, 2]], 
   r2[[5, 2]], 
   r2[[6, 2]], 
   r2[[7, 2]], 
   r2[[8, 2]], 
   r2[[9, 2]], 
   r2[[10, 2]]
   )

T2$quartils_pre <- c(
   r3[[1, 2]],   
   r3[[2, 2]],   
   r3[[3, 2]],   
   r3[[4, 2]],   
   r3[[5, 2]],   
   r3[[6, 2]],   
   r3[[7, 2]],   
   r3[[8, 2]],   
   r3[[9, 2]],   
   r3[[10, 2]] 
)

oldnm <- (names(T2))

names(T2) <- LETTERS[1:(ncol(T2))]

T2 <- 
T2 %>% 
   mutate_all(as.numeric) %>% 
   mutate(Variacio1 = round((C-B)/B * 100,1), 
          Variacio2 = round((D-B)/B * 100,1)
          )

names(T2) <- c(oldnm, "Nous_decils", "Antics_decils")

mykable(T2)

```

```{r}
T2 %>% 
   ggplot(., 
          aes(x = Decil, 
              y = `Nous_decils`, 
              fill = `Nous_decils`, 
              label = `Nous_decils`)) +
   geom_bar(stat = "identity") + 
   geom_text(size = 2.5, color = "black", vjust = 1.5) +
   scale_fill_distiller(palette = "Reds") +
   theme_minimal() +
   labs(
      title = "Variació renda mitjana per decils (nous decils post-simulació)"
   )
   
```

```{r}
T2 %>% 
   ggplot(., 
          aes(x = Decil, 
              y = `Antics_decils`, 
              fill = `Antics_decils`, 
              label = `Antics_decils`)) +
   geom_bar(stat = "identity") + 
   geom_text(size = 2.5, color = "black", vjust = 1.5) +
   scale_fill_distiller(palette = "Reds") +
   theme_minimal() +
   labs(
      title = "Variació renda mitjana per decils (decils inicials pre-simulació)"
   )
   
```


### Taula 2.1 

Variació relativa en la mitjana dels ingressos equivalents de la població  segons decils de renda agrupats

```{r}

df$COV_deciles_IMV3 <- df$COV_deciles_IMV
levels(df$COV_deciles_IMV3) <- c(rep("Baixos", 3), 
                                 rep("Intermedis", 4), 
                                 rep("Alts", 3))

df$deciles_orig3 <- df$deciles_orig
levels(df$deciles_orig3) <- c(rep("Baixos", 3), 
                                 rep("Intermedis", 4), 
                                 rep("Alts", 3))

r22 <- df %>% 
   group_by(COV_deciles_IMV3) %>% 
   summarise(avg = Hmisc::wtd.mean(.data$COV_IE_IMV, 
                                   weights = .data$RB050, 
                                   na.rm = T))

r33 <- df %>% 
   group_by(deciles_orig3) %>% 
   summarise(avg = Hmisc::wtd.mean(.data$COV_IE_IMV, 
                                   weights = .data$RB050, 
                                   na.rm = T))

```

```{r}
t23 <- df %>% 
   group_by(deciles_orig3) %>% 
   summarise(`2019` = Hmisc::wtd.mean(.data$INGRESSOS_EQUIV, 
                                   weights = .data$RB050, 
                                   na.rm = T)) %>% 
   rename(Decil = deciles_orig3)
```

```{r}
t23$quartils_sim <- c(
   r22[[1, 2]], 
   r22[[2, 2]], 
   r22[[3, 2]]
   )

t23$quartils_pre <- c(
   r33[[1, 2]],   
   r33[[2, 2]],   
   r33[[3, 2]] 
)

oldnm <- (names(t23))

names(t23) <- LETTERS[1:(ncol(t23))]

t23 <- 
t23 %>% 
   mutate_all(as.numeric) %>% 
   mutate(Variacio1 = round((C-B)/B * 100,1), 
          Variacio2 = round((D-B)/B * 100,1)
          )

names(t23) <- c(oldnm, "Nous_decils", "Antics_decils")

mykable(t23)

```

```{r}
t23 %>% 
   ggplot(., 
          aes(x = Decil, 
              y = `Nous_decils`, 
              fill = `Nous_decils`, 
              label = `Nous_decils`)) +
   geom_bar(stat = "identity") + 
   geom_text(size = 2.5, color = "black", vjust = 1.5) +
   scale_fill_distiller(palette = "Reds") +
   theme_minimal() +
   labs(
      title = "Variació renda mitjana per decils (nous decils post-simulació)"
   )
   
```

```{r}
t23 %>% 
   ggplot(., 
          aes(x = Decil, 
              y = `Antics_decils`, 
              fill = `Antics_decils`, 
              label = `Antics_decils`)) +
   geom_bar(stat = "identity") + 
   geom_text(size = 2.5, color = "black", vjust = 1.5) +
   scale_fill_distiller(palette = "Reds") +
   theme_minimal() +
   labs(
      title = "Variació renda mitjana per decils (decils inicials pre-simulació)"
   )
   
```


### Taula 2.2 

Mitjana dels IE de la població segons agrupació de decils de renda (constants darrer any) abans de transferències socials, diferenciant erto, IMV i resta de prestacions (atur)
```{r eval=FALSE, include=FALSE}
df %>% 
   group_by(deciles_orig3) %>% 
   mutate(Dif_py010_ertos = COV_suma_rendes_treb - COV_py010_ert) %>% 
   select(ID, deciles_orig3, 
          PY010N, PY050N, PY021N,
          COV_suma_rendes_treb,
          COV_py010_ert, 
          Dif_py010_ertos) %>% View(.)
```


```{r}

df %>% 
   group_by(deciles_orig3) %>% 
   mutate(Dif_py010_ertos = PY010N - COV_py010_ert) %>% 
   summarise(
      total_renda_inicial_M = sum(vhRentaa * RB050)/1000000, 
      total_renda_simulada_M = sum(COV_hy020_IMV * RB050)/1000000, 
      total_RS_pre_IMV_M = sum(COV_hy020 * RB050)/1000000,
      Dif_total_salari_ertos = sum(Dif_py010_ertos, na.rm = T)
      ) %>% View(.)



df %>% 
   group_by(deciles_orig3) %>% 
   summarise(inicial = Hmisc::wtd.mean(.data$INGRESSOS_EQUIV, 
                                   weights = .data$RB050, 
                                   na.rm = T), 
             simulada = Hmisc::wtd.mean(.data$COV_IE_IMV, 
                                   weights = .data$RB050, 
                                   na.rm = T), 
             abans_IMV = Hmisc::wtd.mean(.data$COV_IE, 
                                   weights = .data$RB050, 
                                   na.rm = T), 
             abans_erto = , 
             abans_atur = 
             
             )

```

```{r}
t23 <- df %>% 
   group_by(deciles_orig3) %>% 
   summarise(`2019` = Hmisc::wtd.mean(.data$INGRESSOS_EQUIV, 
                                   weights = .data$RB050, 
                                   na.rm = T)) %>% 
   rename(Decil = deciles_orig3)
```

```{r}
t23$quartils_sim <- c(
   r22[[1, 2]], 
   r22[[2, 2]], 
   r22[[3, 2]]
   )

t23$quartils_pre <- c(
   r33[[1, 2]],   
   r33[[2, 2]],   
   r33[[3, 2]] 
)

oldnm <- (names(t23))

names(t23) <- LETTERS[1:(ncol(t23))]

t23 <- 
t23 %>% 
   mutate_all(as.numeric) %>% 
   mutate(Variacio1 = round((C-B)/B * 100,1), 
          Variacio2 = round((D-B)/B * 100,1)
          )

names(t23) <- c(oldnm, "Nous_decils", "Antics_decils")

mykable(t23)

```

```{r}
t23 %>% 
   ggplot(., 
          aes(x = Decil, 
              y = `Nous_decils`, 
              fill = `Nous_decils`, 
              label = `Nous_decils`)) +
   geom_bar(stat = "identity") + 
   geom_text(size = 2.5, color = "black", vjust = 1.5) +
   scale_fill_distiller(palette = "Reds") +
   theme_minimal() +
   labs(
      title = "Variació renda mitjana per decils (nous decils post-simulació)"
   )
   
```

```{r}
t23 %>% 
   ggplot(., 
          aes(x = Decil, 
              y = `Antics_decils`, 
              fill = `Antics_decils`, 
              label = `Antics_decils`)) +
   geom_bar(stat = "identity") + 
   geom_text(size = 2.5, color = "black", vjust = 1.5) +
   scale_fill_distiller(palette = "Reds") +
   theme_minimal() +
   labs(
      title = "Variació renda mitjana per decils (decils inicials pre-simulació)"
   )
   
```


### Taula 3.1. 

Índex de Gini 

```{r}
g21 <- df %>% 
   summarise(laeken::gini(inc = COV_IE_Gini_IMV, 
                          weights = RB050)$value) %>% 
   .[1,1] %>% 
   pull(.) %>% round(., 1)
```


```{r}

anys <- bind_cols(
   num = c(1985, 1990, 1995, 2000, 2006, 
           2011, 2016, 2017, 2018, 2020.01), 
   lab = edicions1
)

T31 <- taules$Taula31

T31 <- rbind(T31, 
                 c(Any = "sim2020", 
                   Valor = g21, 
                   `Sèrie` = "Sim - EMCV"))
mykable(T31)
```

```{r eval=FALSE, include=FALSE}
T31 %>% 
   mutate(anyN = anys$num[match(.$Any, anys$lab)], 
          Valor = as.numeric(Valor)) %>% 
   ggplot(., 
          aes(x = anyN, 
              y = Valor, 
              color = `Sèrie`)) + 
   geom_line() + 
   geom_segment(aes(x = 2006, 
                    y = 30.8, 
                    xend = 2011, 
                    yend = 34.6), 
                linetype = "dashed", 
                color = "gray50") +
   geom_segment(aes(x = 2011, 
                    y = 34.6, 
                    xend = 2016, 
                    yend = 33.4), 
                linetype = "dashed", 
                color = "gray50") +
   geom_segment(aes(x = 2019, 
                    y = 34.0, 
                    xend = 2020, 
                    yend = g21), 
                linetype = "dashed", 
                color = "gray50") +
   geom_point(size = 3) +
   scale_color_brewer(palette = "RdGy") +
   ylim(0, NA) + 
   scale_x_continuous(breaks = anys$num, 
                      labels = c(anys$lab)) +
   theme(axis.text.x  = element_text(angle = 30, 
                                     vjust = 0.7, 
                                     hjust = .9), 
         panel.grid.minor = element_blank(), 
         legend.position = "bottom") +
   labs(
      x = NULL, 
      y = "Gini", 
      color = "Sèrie"
   )


```


### Taula 3.2. 

Raons de desigualtat entre decils de renda

```{r}
source(here::here("R", "181105_Quantile_income_ratio_P.R"))
# source("~/Dropbox/R/01_Repo_codi_propi/2. Analitza dades/181105_Quantile_income_ratio_P.R")

p21 <- 
df %>% 
   summarise(
      `P50/10` = cal_QuantRat(Qnume = .5,
                              Qdenom = .1,
                              nom_dades = .,
                              IV = "COV_IE_Gini_IMV"),
      `P80/20` = cal_QuantRat(Qnume = .8,
                              Qdenom = .2,
                              nom_dades = .,
                              IV = "COV_IE_Gini_IMV"),
      `S80/20` = laeken::qsr(inc = COV_IE_Gini_IMV, 
                             weights = RB050)$value,
      `P90/50` = cal_QuantRat(Qnume = .9,
                              Qdenom = .5,
                              nom_dades = .,
                              IV = "COV_IE_Gini_IMV"),
      `P90/10` = cal_QuantRat(Qnume = .9,
                              Qdenom = .1,
                              nom_dades = .,
                              IV = "COV_IE_Gini_IMV")
   )

mykable(p21)

```

```{r eval=FALSE, include=FALSE}
do %>% 
   summarise(
      `P50/10` = cal_QuantRat(Qnume = .5,
                              Qdenom = .1,
                              nom_dades = .,
                              IV = "COV_IE_Gini_IMV"),
      `P90/50` = cal_QuantRat(Qnume = .9,
                              Qdenom = .5,
                              nom_dades = .,
                              IV = "COV_IE_Gini_IMV")
   )
```

```{r}

T32 <- taules$Taula32
T32$sim2020 <- c(pull(p21[1,3]), 
                 pull(p21[1,1]))

T32 %>% 
   mykable(.)


```

```{r}
T32 %>% 
   gather("Any", "Val", -Raons) %>% 
   mutate(Any = factor(Any, 
                       levels = edicions1
                       )) %>% 
   ggplot(., 
          aes(x = Any, 
              y = Val, 
              group = Raons, 
              color = Raons)) + 
   geom_point() + 
   geom_line() + 
   scale_colour_manual(values = my_pal) +
   ylim(0, NA) +
   labs(
      y = "Raó"
   ) +
   theme_minimal()

```


### Taula 4.1 

Taxes de risc de pobresa segons intensitat

```{r}

g31 <- 
df %>% 
   summarise(
      p60  = sum(RB050[COV_TRP_IMV60     == "Pobre"]), 
      p40  = sum(RB050[COV_TRP_IMV40     == "Pobre"]), 
      p30  = sum(RB050[COV_TRP_IMV30     == "Pobre"]),
      pa60 = sum(RB050[COV_TRP_ANC_IMV60 == "Pobre"]), 
      pa40 = sum(RB050[COV_TRP_ANC_IMV40 == "Pobre"]), 
      pa30 = sum(RB050[COV_TRP_ANC_IMV30 == "Pobre"]),
      tt  = sum(RB050)
   ) %>% 
   mutate(across(everything(), ~ fes_pp(x = .x, tt)))
   
```

```{r}

T4 <- taules$Taula41
T4$sim2020 <- c(g31[[1,1]], 
                g31[[1,2]], 
                g31[[1,3]])

T4 %>% 
   mykable(.)

```

```{r}
anys <- bind_cols(
   num = c(2011, 2016, 2017, 2018, 2020.01), 
   lab = edicions2[2:6]
)

T4 %>% 
   mutate(Tip = rep("Inicial", 3)) %>% 
   gather(., "Any", "Val", -c(indicador, Tip)) %>% 
   bind_rows(., 
             bind_cols(
   indicador = c("moderada (60%)", 
                 "severa (40%)", 
                 "extrema (30%)"), 
   Any       = rep("sim2020", 3), 
   Val       = unlist(c(g31[4:6])), 
   Tip       = rep("Ancorada", 3))
   ) %>% 
   mutate(anyN = anys$num[match(.$Any, anys$lab)]) %>% 
   ggplot(., 
          aes(x = anyN, 
              y = Val, 
              color = Tip, 
              group = indicador)) +
   geom_line(size = 0.4, color = "gray85") + 
   geom_point(size = 2.5) + 
   scale_x_continuous(breaks = anys$num, 
                      labels = c(anys$lab)) +
   scale_colour_manual(values = my_pal) +
   ylim(0, NA) + 
   theme_minimal() + 
   theme(panel.grid.minor = element_blank(), 
         axis.text.x  = element_text(angle = 30, 
                                     vjust = 0.7, 
                                     hjust = .9)
         ) +
   labs(
      x = NULL, 
      y = "(%)", 
      color = NULL
   )

```

### Taula 4.2. 

Intensitat de risc de pobresa

> % distance to poverty threshold:  The indicator is calculated as the distance between the median equivalised total net income of persons below the at-risk-of-poverty threshold and the at-risk-of-poverty threshold itself, expressed as a percentage of the at-risk-of-poverty threshold. This threshold is set at 60 % of the national median equivalised disposable income of all people in a country and not for the EU as a whole.


```{r}

llindar <- Hmisc::wtd.quantile(x       = df$COV_IE_IMV, 
                               weights = df$RB050, 
                               probs   = c(.5)) * .6
mediana_p <- df %>% 
   filter(COV_TRP_IMV60 == "Pobre") %>% 
   summarise(med_p = Hmisc::wtd.quantile(x       = COV_IE_IMV, 
                                         weights = RB050, 
                                         probs   = c(.5)))

p31 <- round((llindar - mediana_p) / llindar, 3)
   
```

```{r eval=FALSE, include=FALSE}

llindaro <- Hmisc::wtd.quantile(x      = do$IE, 
                               weights = do$RB050, 
                               probs   = c(.5)) * .6

mediana_o <- do %>% 
   filter(TRP60 == "Pobre") %>% 
   summarise(med_p = Hmisc::wtd.quantile(x       = IE, 
                                         weights = RB050, 
                                         probs   = c(.5)))

round((llindaro - mediana_o) / llindaro, 2)

```

```{r}
T42 <- taules$Taula42
T42$sim2020 <- c(p31, llindar, mediana_p)

T42 %>% 
      knitr::kable(., digits = 3, "html") %>% 
      kable_styling(bootstrap_options =
                       c("striped", 
                         "hover", 
                         "condensed", 
                         "responsive"), 
                    full_width = F, 
                    position = "left")

```

### Taula 4.3 

Pobresa ancorada (2018-2019) segons diferent intensitat. Llindar 2018-2019 

```{r}
g41 <- 
df %>% 
   summarise(
      p60 = sum(RB050[COV_TRP_ANC_IMV60 == "Pobre"]), 
      p40 = sum(RB050[COV_TRP_ANC_IMV40 == "Pobre"]), 
      p30 = sum(RB050[COV_TRP_ANC_IMV30 == "Pobre"]),
      tt  = sum(RB050)
   ) %>% 
   mutate(across(everything(), ~ fes_pp(x = .x, tt)))
```


```{r}
T43 <- taules$Taula43
T43$sim2020 <- c(g41[[1,1]], g41[[1,2]], g41[[1,3]])

 
T43 %>% 
   mykable(.)

```

### Taula 5. 

Canvis a la pobresa estimada (60% mediana) segons característiques sociodemogràfiques

```{r eval=FALSE, include=FALSE}

mvars <- c("RB090", "RB080_R8", "PB210", 
           "HX060_R1", "ESEC4")

g51A <- 
purrr::map(mvars, function(x){
   X <- sym(x)
 
   df %>%
      group_by({{X}}) %>%
      count(COV_TRP_IMV60, wt = RB050) %>%
      mutate(tt = sum(n),
             pp = n/tt*100) %>%
      filter(COV_TRP_IMV60 == "Pobre") %>%
      pull(pp)
})

g51B <- 
purrr::map(mvars, function(x){
   X <- sym(x)
 
   df %>%
      group_by({{X}}) %>%
      count(COV_TRP_ANC_IMV60, wt = RB050) %>%
      mutate(pp = n/sum(n)*100) %>%
      filter(COV_TRP_ANC_IMV60 == "Pobre") %>%
      pull(pp)
})

```

```{r eval=FALSE, include=FALSE}
do %>% 
   group_by(HX060_R1) %>% 
   count(TRP60, wt = RB050) %>% 
   mutate(pp = n/sum(n)) %>% 
   filter(TRP60 == "Pobre")
   
do %>% 
   filter(!is.na(ESEC6)) %>% 
   group_by(ESEC6) %>% 
   count(TRP60, wt = RB050) %>% 
   mutate(pp = n/sum(n)) %>% 
   filter(TRP60 == "Pobre")
   
```

```{r eval=FALSE, include=FALSE}
T5 <- taules$Taula5

T5$sim2020 <- c(
g51A[[1]][1], g51A[[1]][2], g51A[[2]][1], 
g51A[[2]][2], g51A[[2]][3], g51A[[2]][4], 
g51A[[3]][1], g51A[[3]][2], g51A[[4]][4], 
g51A[[4]][3], g51A[[4]][2], g51A[[4]][1], 
g51A[[5]][1], g51A[[5]][2], g51A[[5]][3], 
g51A[[5]][4], g51A[[5]][5], g51A[[5]][6])

T5$ANC2020 <- c(
g51B[[1]][1], g51B[[1]][2], g51B[[2]][1], 
g51B[[2]][2], g51B[[2]][3], g51B[[2]][4], 
g51B[[3]][1], g51B[[3]][2], g51B[[4]][4], 
g51B[[4]][3], g51B[[4]][2], g51B[[4]][1], 
g51B[[5]][1], g51B[[5]][2], g51B[[5]][3], 
g51B[[5]][4], g51B[[5]][5], g51B[[5]][6])

T5 %>% mykable(.)

```

```{r eval=FALSE, include=FALSE}
T5 %>% 
   select(-`17-18`) %>% 
   gather("Any", "Val", -c(var, categories)) %>% 
   ggplot(., 
          aes(y = categories, 
              x = Val, 
              color = Any, 
              group = categories)) +
   geom_line(color = "gray", 
                 linetype = "dashed", 
                 size = .3) + 
   geom_point() +
   scale_colour_manual(values = my_pal) +
   theme_minimal() + 
   facet_grid(var~., drop = T, scales = "free_y") + 
   labs(
      x = NULL, 
      y = NULL, 
      color = NULL
   )

```



### Taula 6. 

Proporció mitjana de la renda anual (neta) de les llars que es destina a les despeses fixes de l'habitatge (sense amortització), segons règim de tinença de l'habitatge.

```{r externalitzat_funcions, eval=FALSE, include=FALSE}
df$COV_HCB <- (((df$HH070 * 12) - df$HY070N)/(df$COV_hy020_IMV - df$HY070N)) * 100

# Correccions necessàries
df$COV_HCB[((df$HH070 * 12) - df$HY070N) < 0] <- 0 # Si les despeses llar menys les transferències és menor a 0 (les transferències cobreixen més que les despeses), la sobrecàrrega és 0
df$COV_HCB[(df$COV_hy020_IMV - df$HY070N) <= 0] <- 100 #Si els ingressos menys les transferències és menor que 0 (tots els ingressos són les transferències per llar), la sobrecàrrega és 100
df$COV_HCB[(df$COV_hy020_IMV - df$HY070N) < ((df$HH070*12) - df$HY070N)] <- 100 #si ingressos menys transferències és menor a despeses menys transferències, la sobrecàrrega és 100

df$COV_Taxa_HCB <- as.factor(
   cut(df$COV_HCB, 
   breaks = c(0, 40, 100), 
   include.lowest = T, 
   right = T, 
   labels = c("Sense sobrecàrrega", 
              "Amb sobrecàrrega")))

df$COV_Taxa_HCB60 <- as.factor(
   cut(df$COV_HCB, 
   breaks = c(0, 60, 100), 
   include.lowest = T, 
   right = T, 
   labels = c("Sense sobrecàrrega", 
              "Amb sobrecàrrega")))
   
```

```{r eval=FALSE, include=FALSE}
p51 <- df %>% 
   group_by(RTL3) %>% 
   summarise(mitjana = 
                Hmisc::wtd.mean(COV_HCB, 
                              weights = RB050)
             ) %>% 
   pull(mitjana)

p52 <- df %>% 
   summarise(mitjana = 
                Hmisc::wtd.mean(COV_HCB, 
                              weights = RB050)
             ) %>% 
   pull(mitjana)

```

```{r originals_6, eval=FALSE, include=FALSE}
do %>% 
   group_by(RTL3) %>% 
   summarise(mitjana = 
                Hmisc::wtd.mean(HCB, 
                              weights = RB050)
             ) 

do %>% 
   summarise(mitjana = 
                Hmisc::wtd.mean(HCB, 
                              weights = RB050)
             ) 
```

```{r eval=FALSE, include=FALSE}
T6 <- taules$Taula6
T6$sim2020 <- c(p51[1], p51[2],
                p51[3], p51[4], 
                p52)
T6 %>% 
   mykable(.)

```


### Taula 7. 

Taxa de sobrecàrrega despeses habitatge (sense amortització) amb diferents llindars

```{r eval=FALSE, include=FALSE}
p61 <- 
df %>% 
   group_by(RTL3) %>% 
   count(COV_Taxa_HCB, wt = RB050) %>% 
   mutate(tt = sum(n), 
          pp = n/tt * 100) %>% 
   filter(COV_Taxa_HCB == "Amb sobrecàrrega") %>% 
   pull(pp) %>% 
   round(., 1) 

p62 <- 
df %>% 
   group_by(RTL3) %>% 
   count(COV_Taxa_HCB60, wt = RB050) %>% 
   mutate(tt = sum(n), 
          pp = n/tt * 100) %>% 
   filter(COV_Taxa_HCB60 == "Amb sobrecàrrega") %>% 
   pull(pp) %>% 
   round(., 1) 


```

```{r originals_7, eval=FALSE, include=FALSE}
do$Taxa_HCB60 <- ifelse(do$HCB > 60, T, F)

do %>% 
   filter(!is.na(Taxa_HCB)) %>% 
   group_by(RTL3) %>% 
   count(Taxa_HCB, wt = RB050) %>% 
   mutate(pp = n/sum(n)) %>% 
   filter(Taxa_HCB == "Amb sobrec.")

do %>% 
   filter(!is.na(Taxa_HCB60)) %>% 
   group_by(RTL3) %>% 
   count(Taxa_HCB60, wt = RB050) %>% 
   mutate(pp = n/sum(n)) %>% 
   filter(Taxa_HCB60)

```

```{r eval=FALSE, include=FALSE}
T7 <- taules$Taula7
T7$sim2020 <- c(
   p61[4], # altres 40
   p62[4], # altres 60
   p61[3], # lloguer 40
   p62[3], 
   p61[1], # pagada 40
   p62[1], 
   p61[2], # pagaments 40
   p62[2]
)

T7 <- T7 %>% 
   relocate(perc) %>% 
   mutate(RTL = factor(RTL, levels = c("pagada", "pagaments", "lloguer", "altres"))) %>% 
   arrange(perc, RTL)
   
T7 %>% 
   mykable(.) %>% 
   collapse_rows(columns = 1, valign = "middle")


```

```{r eval=FALSE, include=FALSE}
T7 %>% 
   gather("serie", "Val", -c(RTL, perc)) %>% 
   mutate(Val = as.numeric(Val)) %>% 
   ggplot(., 
          aes(x = serie, 
              y = Val, 
              group = RTL, 
              color = RTL)) + 
   geom_point() +
   geom_line() +
   facet_wrap(.~perc) + 
   theme_minimal() + 
   scale_color_brewer(palette = "RdGy") +
   labs(
      y = "%", 
      x = "Edició", 
      color = "Règim de \ntinença"
   )
   
```


### Taula 8. 

Taxa de risc de pobresa (60% mediana) abans i després del IMV

El llindar de referència fa servir les dades després de la injecció del IMV. 

```{r eval=FALSE, include=FALSE}

# trp60 2019
df %>% 
   count(TRP60, wt = RB050) %>% 
   mutate(pp = n/sum(n)*100)

# trp60 simulada (amb IMV, sense ancorar)
df %>% 
   count(COV_TRP_IMV60, wt = RB050) %>% 
   mutate(pp = n/sum(n)*100)

# trp60 simulada (sense IMV, sense ancorar)
df %>% 
   count(COV_TRP60, wt = RB050) %>% 
   mutate(pp = n/sum(n)*100)


```

```{r}
df %>% 
   select(contains("COV_TRP"), RB050) %>% 
      summarise(
      trp60_abans   = sum(RB050[COV_TRP60 == "Pobre"]), 
      trp40_abans   = sum(RB050[COV_TRP40 == "Pobre"]), 
      trp30_abans   = sum(RB050[COV_TRP30 == "Pobre"]),
      trp60_despres = sum(RB050[COV_TRP_IMV60 == "Pobre"]), 
      trp40_despres = sum(RB050[COV_TRP_IMV40 == "Pobre"]), 
      trp30_despres = sum(RB050[COV_TRP_IMV30 == "Pobre"]),
      tt  = sum(RB050)
   ) %>% 
   mutate(across(everything(), ~ fes_pp(x = .x, tt))) %>% 
   gather("TRP", "Valor") %>% 
   filter(TRP != "tt") %>% 
   separate(TRP, into = c("TRP", "quan")) %>% 
   spread(., quan, Valor) %>% 
   mykable(.)

   
```

